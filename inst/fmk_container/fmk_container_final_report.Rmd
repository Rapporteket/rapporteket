---
title: 'Rapporteket som applikasjonscontainer: Sluttrapport'
author: "Morten Engan (HNIKT), Are Edvardsen (SKDE), Tove Sverkmo (NHN)"
date: "`r format(Sys.time(), '%d. %B, %Y')`"
abstract: 'I mai 2022 ble det fra Teknologiforum for medisinske kvalitetsregistre (FMK) søkt om delfinansiering for tilrettelegging av en mer standardisert og "skybasert" drift av Rapporteket, primært hos Norsk Helsenett. Prosjektet fikk innvilget søknaden i juni og arbeidet startet påfølgende høst i et samarbeid mellom SKDE, Helse Nord IKT og Norsk Helsenett. Ved avslutning i februar 2023 har prosjektet etablert og demonstrert et fungerende oppsett som kan tas i bruk i en fremtidig flytteprosess. I dette ligger det blant annet en definert teknisk arkitektur, ny mellomvare som ivaretar og styrker kjerneegenskaper for applikasjoner på Rapporteket, bruk av eksterne tjenester for autentisering og autorisasjon samt stor skalerbarhet i et fremtidsrettet driftsmiljø. Utover å legge til rette for flytting vil også følgende gevinster kunne forventes: økt utviklingstakt og kvalitet for applikasjoner, mer tydelig ansvarsfordeling mellom applikasjons-utvikling og -drift, forenklet og rimeligere drift og færre avhengigheter til spesifikke komponenter og leverandører.'
reglogo: '`r system.file("fmk_container/fmk_container_final_report_coworker.png", package = "rapporteket")`'
regtext: ''
userFullName: 'FMK'
registryName: 'Prosjektgruppen'
params:
  tableFormat: pdf
---

# Innledning
Rapporteket er en resultattjeneste som tilbyr statistikk og analyser til medisinske kvalitetsregistre og ble satt i drift for første gang i 2011. Utvikling og drift av tjenesten har skjedd i et samarbeid mellom SKDE og Helse Nord IKT. På Rapporteket har hvert register sin egen R-Shiny applikasjon og alle applikasjonene betjenes av en felles applikasjonsserver (shiny-server). En endring der hver applikasjon (Rapporteket for et gitt register) kjøres som en selvstendig enhet innpakket i en applikasjonscontainer vil gi en rekke gevinster: betydelig forenkling av driftsoppgaver, lavere risiko for at feil påvirker andre deler av systemet samt at ansvarsdelingen mellom utviklings- og driftsoppgaver vil bli mer tydelig. Utfordringen ligger i å gjøre kloke valg av arkitektur, teknologi og metodikk som er tåler fremtidige endringer og som samtidig ivaretar best mulig kvalitet på de resultattjenestene som skal leveres. Eksempler på en fremtidige endringer kan være skifte av driftsleverandør eller behov for endringer av teknologi og funksjonalitet.

Over tid er det fra mange hold ytret et ønske om å flytte teknisk drift fra Helse Nord IKT til en nasjonal aktør og dette prosjektet har etablert og demonstrert et fungerende oppsett som legger til rette for at flytteprosessen kan starte.


# Leveranser

I prosjektsøknaden ble gjennomføring av følgende oppgaver pekt på som sentrale for nå målet for prosjektet:

* utvikle og teste teknisk arkitektur,

* teste og etablere metoder for kontinuerlig integrasjon og leveranse (ci/cd),

* utvide ShinyProxy for integrasjon mot OpenID-tjenester som benytter PKCE-flyt, og

* teste Falk som identitetsleverandør til Rapporteket

Avsluttende status og resultater fra prosjektet er gitt under.

Avsluttende status og resultater fra prosjektet er gitt under.

## Prosjektstatus ved avslutning
Leveranser til prosjektet har i kommet fra SKDE, Helse-Nord IKT og Norsk Helsenett og involverte personer er gitt i tabell \@ref(tab:pers).

```{r make table pers, results='asis', echo=FALSE}
tabData <- data.frame(
  HNIKT = c(
    "Morten Engan",
    "Sigurd Hansen",
    "Jan-Henrik Hasselberg",
    "Ketil Holden",
    "Brigt Agnar Mikkelsen",
    "Wael Ruba",
    "Børge Jakobsen",
    "",
    ""
  ),
  SKDE =  c(
    "Are Edvardsen",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    ""
  ),
  NHN = c(
    "Tove Sverkmo",
    "Borgar Føll Flytør",
    "Kristian Nordtømme",
    "Ida Hellsaa",
    "Vegard Jørgensen",
    "Håvard Elnan",
    "Jon Ramy Andersen",
    "Håvard Wang",
    "Kenneth Vanvik"
  )
)

cap <- paste(
  "Organisasjoner og personer som har deltatt aktivt i prosjektet.",
  "SKDE = Senter for klinisk dokumentasjon og evaluering, Helse Nord RHF,",
  "HNIKT = Helse Nord IKT HF, NHN = Norsk Helsenett"
)

rapbase::mst(tab = tabData, cap = cap, label = "pers", align = "lll",
             type = params$tableFormat)

```

I alt er prosjektet fakturert XX arbeidstimer og leie av infrastruktur og driftsmiljøfor til sammen kr YYY YYYY i all hovedsak fra aktivitet hos Norsk Helsenett (?). Det ble også levert et betydelig men ukjent antall selvfinansierte arbeidstimer fra SKDE og Helse Nord IKT. Ved prosjektslutt gjenstår det til sammen kr ZZ som i sin helhet tilbakeføres til Teknologiforum for medisinske kvalitetsregistre (FMK).

## Teknisk arkitektur
Utgangspunktet for oppsett av infrastruktur ble hentet fra forprosjektet og etablert i to utgaver: ett hos HNIKT for utprøving og justeringer gjennom prosjektet og ett hos NHN som et replikat av oppsettet hos HNIKT men med formål å representere et reelt driftsmiljø. Endelig oppsett hos NHN er vist i Figur \ref{fig:arch}.

> _Teknisk arkitektur slik den er utarbeidet her er fremtidsrettet og i stand til å understøtte alle oppgaver knyttet til drift av Rapporteket. Med fremtidsrettet menes det at valgt løsningen har fokus på høy grad av automatisering og skalerbarhet knyttet til livssyklus og bruk av relevante applikasjoner. Prosjektet har gjennom fullskala testing demonstrert at valgt arkitektur understøtter alle kjente oppgaver for applikasjonere som skal kjøre på Rapporteket._ 

\begin{figure}[H]
%\includegraphics[width=0.95\textwidth, height=!]{/home/rstudio/rapporteket/inst/fmk_container/arch.png}
\includegraphics[width=0.95\textwidth, height=!]{`r system.file("fmk_container/arch.png", package = "rapporteket")`}
\centering
\caption{Systembeskrivelse av driftsmiljø for Rapporteket hos Norsk Helsenett.}
\label{fig:arch}
\end{figure}


## Kontinuerlig integrasjon og leveranse
Et viktig mål i prosjektet har vært å identifisere og prøve ut tiltak for økt effektivitet og kvalitet i forbindelse med endring i programvare (applikasjoner på Rapporteket) og dritssetting. Ved sammenkobling av systemer (integrasjon) og automatisering av prosesser kan takten for oppgradering av programvare økes samtidig som sannsynligheten for feil reduseres. En av hovedutfordringene her er at ansvaret for utvikling og drift av programvare tilhører ulike organisasjoner.

Se figurene \ref{fig:baseimage}, \ref{fig:appimage}, \ref{fig:deploy} og \ref{fig:cicd}.

\begin{figure}[H]
\includegraphics[width=0.95\textwidth, height=!]{`r system.file("fmk_container/base_image.png", package = "rapporteket")`}
\centering
\caption{Skisse av automatisert og manuelle prosesser for etablering av basis image for container applikasjoner (registre) på Rapporteket. Basis imaget inneholder i hovedsak et tynt OS og programvaremiljøet R.}
\label{fig:baseimage}
\end{figure}

\begin{figure}[H]
\includegraphics[width=0.95\textwidth, height=!]{`r system.file("fmk_container/app_image.png", package = "rapporteket")`}
\centering
\caption{Skisse av automatiserte og manuelle prosesser for etablering av et container image for et gitt register på Rapporteket. Imaget bygger på et basis image (over) og R-koden som ligger til grunn for et gitt register på Rapporteket.}
\label{fig:appimage}
\end{figure}

\begin{figure}[H]
\includegraphics[width=0.95\textwidth, height=!]{`r system.file("fmk_container/deploy.png", package = "rapporteket")`}
\centering
\caption{Skisse av prosessen for driftsetting av container applikasjoner. De to fargekodede radene angir ansvarsområdene og kolonnene skiller mellom prosessene for deploy til kvalitetskontroll (QA) og produksjon.}
\label{fig:deploy}
\end{figure}

\begin{figure}[H]
\includegraphics[width=0.95\textwidth, height=!]{`r system.file("fmk_container/ci_cd.png", package = "rapporteket")`}
\centering
\caption{Skjermdump av offentlig image register (hub.docker.com) og privat register hos Norsk Helsenett (Harbor)}
\label{fig:cicd}
\end{figure}



## ShinyProxy og OpenID med PKCE-flyt

Se figur \ref{fig:spdeploy}.

\begin{figure}[H]
\includegraphics[width=0.95\textwidth, height=!]{`r system.file("fmk_container/sp_deploy.png", package = "rapporteket")`}
\centering
\caption{Skjermdump av deploy av ShinyProxy gjennom Argo CD i driftsmiljøet hos Norsk Helsenett.}
\label{fig:spdeploy}
\end{figure}

## Falk som identitetsleverandør til Rapporteket

## Biprodukter fra prosjektet

Se figurene \ref{fig:luablanor} og \ref{fig:scablanor}.

\begin{figure}[H]
\includegraphics[width=0.95\textwidth, height=!]{`r system.file("fmk_container/LU_ablanor.png", package = "rapporteket")`}
\centering
\caption{Nasjonalt register for ablasjonsbehandling og elektrofysiologi i Norge (AblaNor) ble brukt som testregister i prosjektet. Bildet noen av funksjonalitetene i denne applikasjonen: bruk av prefabrikkerte (staging) data og brukerstyrt rapportabonnement.}
\label{fig:luablanor}
\end{figure}

\begin{figure}[H]
\includegraphics[width=0.95\textwidth, height=!]{`r system.file("fmk_container/SC_ablanor.png", package = "rapporteket")`}
\centering
\caption{Illustrasjon av ulike brukertilganger basert på informasjon fra innloggingstjenesten (Falk) og lokalt tilgangstree.}
\label{fig:scablanor}
\end{figure}


# Anbefalinger

## Endring av driftsleverandør

## Videre utvikling


